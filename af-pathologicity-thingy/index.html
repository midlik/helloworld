<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>AlphaFold Pathologicity View Prototype</title>

    <!-- Molstar CSS & JS -->
    <link rel="stylesheet" type="text/css"
        href="https://www.ebi.ac.uk/pdbe/pdb-component-library/css/pdbe-molstar-light-3.1.3.css">
    <script type="text/javascript"
        src="https://www.ebi.ac.uk/pdbe/pdb-component-library/js/pdbe-molstar-plugin-3.1.3.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            padding-block: 30px;
            padding-inline: 40px;
        }

        h1,
        .controlSection {
            font-family: "IBM Plex Sans", sans-serif;
        }

        .msp-plugin ::-webkit-scrollbar-thumb {
            background-color: #474748 !important;
        }

        #myViewer {
            width: 900px;
            height: 600px;
            position: relative;
            margin-block: 20px;
        }

        button {
            margin-right: 10px;
            margin-bottom: 15px;
            padding: 4px;
        }

        .legend-square {
            display: inline-block;
            width: 0.8em;
            height: 0.8em;
            border: solid black 1px;
            margin-right: 5px;
        }

        p {
            padding-block: 0.08em;
        }
    </style>

</head>

<body>

    <div class="viewerSection">
        <h1>AlphaFold Pathologicity View Prototype</h1>
        <!-- Molstar container -->
        <div id="myViewer"></div>
    </div>

    <div class="controlSection">
        <button onclick="colorByData()">
            Color by pathologicity
        </button>
        <button onclick="viewerInstance.visual.clearSelection()">
            Color by pLDDT
        </button>
        <div>
            <p><strong>Pathologicity classes</strong></p>
            <p>
            <div class="legend-square" style="background-color: #0000bb;"></div>Benign</p>
            <p>
            <div class="legend-square" style="background-color: #ffffff;"></div>Ambiguous</p>
            <p>
            <div class="legend-square" style="background-color: #ff0000;"></div>Pathological</p>
        </div>
    </div>


    <script>
        const BASE = { r: 255, g: 255, b: 255 };
        const COLOR_MAP = {
            benign: { r: 62, g: 82, b: 164 },
            ambiguous: { r: 200, g: 200, b: 200 },
            pathogenic: { r: 238, g: 61, b: 57 },
            // pathological: { r: 238, g: 61, b: 57 },
        }
        const COLOR_MAP_CONTINUOUS = {
            min: { r: 0, g: 0, b: 187 }, // #
            center: { r: 255, g: 255, b: 255 }, // #ffffff
            max: { r: 255, g: 0, b: 0 }, // #ff0000
        }

        function parseData(data) {
            const DELIMITER = ',';
            const MUTATION_COLUMN = 0;
            const SCORE_COLUMN = 1;
            const CLASS_COLUMN = 2;
            const N_HEADER_ROWS = 0;
            const lines = data.split('\n').filter(line => line.trim() !== '' && !line.trim().startsWith('#'));
            if (N_HEADER_ROWS > 0) lines.splice(0, N_HEADER_ROWS);
            const rows = lines.map(line => line.split(DELIMITER));
            const scores = {}; // { [seq_id: number]: number[] }
            for (const row of rows) {
                const mutation = row[MUTATION_COLUMN];
                const score = Number(row[SCORE_COLUMN]);
                const cls = row[CLASS_COLUMN];
                const match = mutation.match(/([A-Za-z]+)([0-9]+)([A-Za-z]+)/);
                const seq_id = match[2];
                (scores[seq_id] ??= []).push(score);
            }
            const colors = [];
            for (const seq_id in scores) {
                const aggrScore = aggregationFunction(scores[seq_id]);
                const color = assignColor(aggrScore);
                colors.push([Number(seq_id), color]);
            }
            return colors;
        }

        function mean(values) {
            return values.reduce((a, b) => a + b, 0) / values.length;
        }
        const aggregationFunction = mean; // The original paper also uses mean (https://www.science.org/doi/10.1126/science.adg7492)

        function assignColor1(score) {
            if (score < 0.35) return COLOR_MAP.benign;
            if (score < 0.60) return COLOR_MAP.ambiguous;
            return COLOR_MAP.pathogenic;
        }
        function assignColor(score) {
            if (score <= 0.5) return mixColor(COLOR_MAP_CONTINUOUS.min, COLOR_MAP_CONTINUOUS.center, 2 * score);
            else return mixColor(COLOR_MAP_CONTINUOUS.center, COLOR_MAP_CONTINUOUS.max, 2 * score - 1);
        }
        function mixColor(color0, color1, q) {
            return {
                r: color0.r * (1 - q) + color1.r * q,
                g: color0.g * (1 - q) + color1.g * q,
                b: color0.b * (1 - q) + color1.b * q,
            };
        }

        function colorByData() {
            console.time('colorByData');
            fetch(`data/${accession}-aa-substitutions.csv`)
                .then(response => response.text())
                .then(data => parseData(data))
                .then(colors => viewerInstance.visual.select({
                    data: [
                        { struct_asym_id: 'A', color: BASE },
                        ...colors.map(x => ({ struct_asym_id: 'A', residue_number: x[0], color: x[1] })),
                    ],
                }))
                .then(() => console.timeEnd('colorByData'));
        }

        // const accession = 'O15552';
        // const accession = 'P08169';
        const accession = 'A0A0A0MRZ7';  // A0A0A0MRZ7, A0A0A0MRZ8, A0A0A0MRZ9, A0A0A0MS00,

        // Create plugin instance
        const viewerInstance = new PDBeMolstarPlugin();
        const options = {
            customData: {
                url: `https://alphafold.ebi.ac.uk/files/AF-${accession}-F1-model_v4.cif`,
                format: 'cif',
                binary: false,
            },
            subscribeEvents: false,
            bgColor: { r: 255, g: 255, b: 255 },
            selectInteraction: false,
            alphafoldView: true,
            reactive: true,
            sequencePanel: true,
            hideCanvasControls: ['animation'],
            pdbeLink: false,
        };
        const viewerContainer = document.getElementById('myViewer');
        viewerInstance.render(viewerContainer, options);

        viewerInstance.events.loadComplete.subscribe(() => colorByData());

    </script>
</body>

</html>